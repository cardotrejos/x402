name: Auto-resolve Bot Threads

on:
  # Trigger after Greptile completes a review
  check_run:
    types: [completed]
  # Also allow manual trigger
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to clean up'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-resolve:
    name: Auto-resolve Bot-only Threads
    runs-on: ubuntu-latest
    # Only run when Greptile check completes successfully
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.check_run.conclusion == 'success' &&
       (github.event.check_run.app.slug == 'greptile-apps' || contains(github.event.check_run.name, 'Greptile')))
    steps:
      - name: Get PR info
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ inputs.pr_number }}"
          else
            # Get PR from check run
            PR_NUMBER=$(gh api \
              "repos/${{ github.repository }}/commits/${{ github.event.check_run.head_sha }}/pulls" \
              --jq '.[0].number' 2>/dev/null)
          fi

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "No PR found, skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          HEAD_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "PR #$PR_NUMBER, HEAD: $HEAD_SHA"

      - name: Verify clean review on current HEAD
        if: steps.pr.outputs.skip != 'true'
        id: verify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_SHA="${{ steps.pr.outputs.head_sha }}"

          # Verify Greptile review is clean for current HEAD
          REVIEW_STATUS=$(gh api \
            "repos/${{ github.repository }}/commits/${HEAD_SHA}/check-runs" \
            --jq '.check_runs[] | select(.app.slug == "greptile-apps" or .name == "Greptile") | .conclusion' \
            2>/dev/null | head -1)

          if [ "$REVIEW_STATUS" != "success" ]; then
            echo "Greptile review not successful ($REVIEW_STATUS) for HEAD $HEAD_SHA, skipping auto-resolve"
            echo "clean=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Clean Greptile review confirmed for HEAD $HEAD_SHA"
          echo "clean=true" >> "$GITHUB_OUTPUT"

      - name: Resolve bot-only threads
        if: steps.pr.outputs.skip != 'true' && steps.verify.outputs.clean == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          # Get all review threads
          QUERY='query($owner: String!, $repo: String!, $pr: Int!) {
            repository(owner: $owner, name: $repo) {
              pullRequest(number: $pr) {
                reviewThreads(first: 100) {
                  nodes {
                    id
                    isResolved
                    comments(first: 50) {
                      nodes {
                        author {
                          login
                        }
                      }
                    }
                  }
                }
              }
            }
          }'

          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          THREADS=$(gh api graphql \
            -f query="$QUERY" \
            -f owner="$OWNER" \
            -f repo="$REPO" \
            -F pr="$PR_NUMBER" \
            --jq '.data.repository.pullRequest.reviewThreads.nodes[]')

          RESOLVED_COUNT=0
          SKIPPED_COUNT=0

          echo "$THREADS" | jq -c '.' | while read -r thread; do
            THREAD_ID=$(echo "$thread" | jq -r '.id')
            IS_RESOLVED=$(echo "$thread" | jq -r '.isResolved')

            # Skip already resolved
            if [ "$IS_RESOLVED" = "true" ]; then
              continue
            fi

            # Check if ALL comments are from bots (greptile-apps[bot] or github-actions[bot])
            NON_BOT_AUTHORS=$(echo "$thread" | jq -r '.comments.nodes[].author.login' | grep -v '\[bot\]$' | grep -v 'github-actions' || true)

            if [ -z "$NON_BOT_AUTHORS" ]; then
              # All comments are from bots â€” safe to auto-resolve
              echo "Resolving bot-only thread: $THREAD_ID"
              gh api graphql -f query="mutation { resolveReviewThread(input: {threadId: \"${THREAD_ID}\"}) { thread { isResolved } } }" > /dev/null 2>&1
              RESOLVED_COUNT=$((RESOLVED_COUNT + 1))
            else
              echo "Skipping thread with human comments: $THREAD_ID (authors: $NON_BOT_AUTHORS)"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            fi
          done

          echo "Auto-resolved $RESOLVED_COUNT bot-only threads, skipped $SKIPPED_COUNT with human comments"
