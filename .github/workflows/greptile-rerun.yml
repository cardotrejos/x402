name: Greptile Rerun

on:
  # Trigger when CI checks complete on a PR
  check_suite:
    types: [completed]
  # Also trigger on PR synchronize (new commits pushed)
  pull_request:
    types: [synchronize]

permissions:
  contents: read
  pull-requests: write
  checks: read

jobs:
  rerun-review:
    name: Request Greptile Re-review
    runs-on: ubuntu-latest
    # Only run for PRs
    if: >-
      (github.event_name == 'pull_request') ||
      (github.event_name == 'check_suite' && github.event.check_suite.pull_requests[0])
    steps:
      - name: Get PR info
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            PR_NUMBER="${{ github.event.check_suite.pull_requests[0].number }}"
            HEAD_SHA="${{ github.event.check_suite.head_sha }}"
          fi
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"
          echo "PR #$PR_NUMBER, HEAD: $HEAD_SHA"

      - name: Check for existing Greptile review on current HEAD
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_SHA="${{ steps.pr.outputs.head_sha }}"
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          # Check if Greptile already reviewed this exact SHA
          GREPTILE_REVIEW=$(gh api \
            "repos/${{ github.repository }}/commits/${HEAD_SHA}/check-runs" \
            --jq '.check_runs[] | select(.app.slug == "greptile-apps" or .name == "Greptile") | .status' \
            2>/dev/null | head -1)

          if [ "$GREPTILE_REVIEW" = "completed" ]; then
            echo "Greptile already reviewed HEAD $HEAD_SHA"
            echo "needs_rerun=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if we already requested a rerun for this SHA (dedupe)
          MARKER="<!-- review-agent-auto-rerun -->"
          SHA_TAG="sha:${HEAD_SHA}"

          ALREADY_REQUESTED=$(gh api \
            "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq "[.[] | select(.body | contains(\"${MARKER}\")) | select(.body | contains(\"${SHA_TAG}\"))] | length" \
            2>/dev/null)

          if [ "$ALREADY_REQUESTED" -gt 0 ] 2>/dev/null; then
            echo "Rerun already requested for SHA $HEAD_SHA"
            echo "needs_rerun=false" >> "$GITHUB_OUTPUT"
          else
            echo "No Greptile review or rerun request for SHA $HEAD_SHA"
            echo "needs_rerun=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Request Greptile re-review
        if: steps.check.outputs.needs_rerun == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_SHA="${{ steps.pr.outputs.head_sha }}"
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          SHORT_SHA="${HEAD_SHA:0:7}"

          MARKER="<!-- review-agent-auto-rerun -->"
          SHA_TAG="sha:${HEAD_SHA}"

          BODY="${MARKER}
          ðŸ”„ **Auto-requesting Greptile re-review**

          | Field | Value |
          |-------|-------|
          | **Trigger** | \`${{ github.event_name }}\` |
          | **Head SHA** | \`${SHORT_SHA}\` |

          @greptile review

          ${SHA_TAG}"

          gh pr comment "$PR_NUMBER" --body "$BODY"
          echo "Requested Greptile re-review for SHA $SHORT_SHA on PR #$PR_NUMBER"
